{% extends "admin_base.html" %}

{% block title %}Gestión de Usuarios - Panel Admin{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-users me-2"></i>Gestión de Usuarios</h2>
    <div class="btn-group">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoUsuarioModal">
            <i class="fas fa-plus me-2"></i>Nuevo Usuario
        </button>
        <button class="btn btn-outline-secondary">
            <i class="fas fa-download me-2"></i>Exportar
        </button>
    </div>
</div>
    
    {% if usuarios %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Cédula</th>
                                        <th>Nombre Completo</th>
                                        <th>Usuario</th>
                                        <th>Email</th>
                                        <th>Rol</th>
                                        <th>Tutor/Docente</th>
                                        <th>Estado</th>
                                        <th>Fecha Registro</th>
                                        <th style="min-width: 350px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for usuario in usuarios %}
                                    <tr>
                                        <td>{{ usuario.cedula }}</td>
                                        <td>{{ usuario.nombre_completo }}</td>
                                        <td>{{ usuario.username }}</td>
                                        <td>{{ usuario.email }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'danger' if usuario.rol == 'admin' else 'primary' if usuario.rol == 'docente' else 'info' }}">
                                                {{ usuario.rol.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if usuario.rol == 'usuario' %}
                                                <div class="dropdown">
                                                    <button class="btn btn-sm {% if usuario.tutor %}btn-success{% else %}btn-secondary{% endif %} dropdown-toggle" type="button" id="tutorDropdown{{ usuario.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        {% if usuario.tutor %}
                                                            <i class="fas fa-user-tie me-1"></i>{{ usuario.tutor.nombre_completo or usuario.tutor.username }}
                                                        {% else %}
                                                            <i class="fas fa-user-slash me-1"></i>Sin tutor
                                                        {% endif %}
                                                    </button>
                                                    <ul class="dropdown-menu" aria-labelledby="tutorDropdown{{ usuario.id }}">
                                                        <li><h6 class="dropdown-header">Seleccionar Tutor</h6></li>
                                                        <li>
                                                            <a class="dropdown-item asignar-tutor-link" href="#" 
                                                               data-usuario-id="{{ usuario.id }}" 
                                                               data-tutor-id="" 
                                                               data-usuario-nombre="{{ usuario.nombre_completo or usuario.username }}"
                                                               data-tutor-nombre="">
                                                                <i class="fas fa-times me-2 text-danger"></i>Sin tutor (Remover)
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        {% for docente in docentes %}
                                                        <li>
                                                            <a class="dropdown-item asignar-tutor-link {% if usuario.tutor_id == docente.id %}active{% endif %}" 
                                                               href="#" 
                                                               data-usuario-id="{{ usuario.id }}" 
                                                               data-tutor-id="{{ docente.id }}" 
                                                               data-usuario-nombre="{{ usuario.nombre_completo or usuario.username }}"
                                                               data-tutor-nombre="{{ docente.nombre_completo or docente.username }}">
                                                                <i class="fas fa-user-tie me-2"></i>{{ docente.nombre_completo or docente.username }}
                                                                {% if docente.curso %} - {{ docente.curso }}{% endif %}
                                                            </a>
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                                {% if usuario.tutor and usuario.tutor.curso %}
                                                    <br><small class="text-muted">{{ usuario.tutor.curso }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if usuario.activo else 'secondary' }}">
                                                {{ 'Activo' if usuario.activo else 'Inactivo' }}
                                            </span>
                                        </td>
                                        <td>{{ usuario.fecha_registro.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <div class="d-flex flex-wrap gap-2 align-items-center" style="min-width: 350px;">
                                                <!-- BOTÓN EDITAR - Siempre visible -->
                                                <button type="button" class="btn btn-primary btn-sm" title="Editar {{ usuario.rol.title() }}" data-bs-toggle="modal" data-bs-target="#editarUsuarioModal{{ usuario.id }}">
                                                    <i class="fas fa-edit me-1"></i>Editar
                                                </button>
                                                
                                                <!-- BOTÓN ELIMINAR - Visible para usuarios y docentes (excepto admin principal y el mismo usuario) -->
                                                {% if usuario.id != session.user_id and not (usuario.rol == 'admin' and usuario.username == 'admin') %}
                                                <form method="POST" action="{{ url_for('admin.eliminar_usuario', usuario_id=usuario.id) }}" class="d-inline" onsubmit="return confirm('¿Está seguro de que desea ELIMINAR a {{ usuario.nombre_completo or usuario.username }}?\\n\\nTipo: {{ usuario.rol.title() }}\\n\\nEsta acción marcará al usuario/docente como INACTIVO.\\n\\n¿Desea continuar?');">
                                                    <button type="submit" class="btn btn-danger btn-sm" title="Eliminar {{ usuario.rol.title() }}">
                                                        <i class="fas fa-trash me-1"></i>Eliminar
                                                    </button>
                                                </form>
                                                {% else %}
                                                <span class="badge bg-secondary">Protegido</span>
                                                {% endif %}
                                                
                                                <!-- Botones adicionales -->
                                                {% if usuario.rol == 'usuario' %}
                                                <button type="button" class="btn btn-info btn-sm" title="Asignar Tutor" data-bs-toggle="modal" data-bs-target="#asignarTutorModal{{ usuario.id }}">
                                                    <i class="fas fa-user-tie me-1"></i>Tutor
                                                </button>
                                                {% endif %}
                                                <button type="button" class="btn btn-warning btn-sm text-white" title="Resetear Contraseña" data-bs-toggle="modal" data-bs-target="#resetPasswordModal{{ usuario.id }}">
                                                    <i class="fas fa-key me-1"></i>Password
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card text-center">
                    <div class="card-body py-5">
                        <i class="fas fa-users text-muted mb-3" style="font-size: 4rem;"></i>
                        <h4 class="text-muted">No hay usuarios registrados</h4>
                        <p class="text-muted">Los usuarios aparecerán aquí una vez que se registren</p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modal para Nuevo Usuario -->
<div class="modal fade" id="nuevoUsuarioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('admin.nuevo_usuario') }}" id="formNuevoUsuario">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cedula" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="cedula" name="cedula" maxlength="10" pattern="[0-9]{10}" title="Debe contener exactamente 10 números">
                            <small class="form-text text-muted">10 dígitos numéricos</small>
                            <div class="invalid-feedback">Por favor solo ingrese números, 10 números</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="nombre_completo" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombre_completo" name="nombre_completo" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+" title="Solo se permiten letras y espacios">
                            <small class="form-text text-muted">Solo se permiten letras y espacios</small>
                            <div class="invalid-feedback">Por favor solo ingrese letras y espacios</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">Usuario <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback">Por favor ingrese un correo electrónico válido</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="telefono" name="telefono" maxlength="10" pattern="[0-9]{10}" title="Debe contener exactamente 10 números">
                            <small class="form-text text-muted">10 dígitos numéricos</small>
                            <div class="invalid-feedback">Por favor solo ingrese números, 10 números</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="password" class="form-label">Contraseña <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" required minlength="6">
                                <button class="btn btn-outline-secondary" type="button" id="togglePasswordNuevoUsuario" title="Mostrar/Ocultar contraseña">
                                    <i class="fas fa-eye" id="eyeIconNuevoUsuario"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">Mínimo 6 caracteres</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rol" class="form-label">Rol <span class="text-danger">*</span></label>
                            <select class="form-select" id="rol" name="rol" required onchange="toggleCamposPorRol()">
                                <option value="usuario">Usuario</option>
                                <option value="docente">Docente</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                    </div>
                    <!-- Campos para Usuario -->
                    <div id="camposUsuario" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="carrera_id" class="form-label">Carrera</label>
                                <select class="form-select" id="carrera_id" name="carrera_id">
                                    <option value="">Seleccione una carrera</option>
                                    {% for carrera in carreras %}
                                    <option value="{{ carrera.id }}">{{ carrera.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Se asignará automáticamente un tutor de esta carrera</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="semestre" class="form-label">Semestre</label>
                                <select class="form-select" id="semestre" name="semestre">
                                    <option value="">Seleccione un semestre</option>
                                    <option value="1">Primer Semestre</option>
                                    <option value="2">Segundo Semestre</option>
                                    <option value="3">Tercer Semestre</option>
                                    <option value="4">Cuarto Semestre</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Campos para Docente -->
                    <div id="camposDocente" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="carrera_asignada_id" class="form-label">Carrera Asignada</label>
                                <select class="form-select" id="carrera_asignada_id" name="carrera_asignada_id">
                                    <option value="">Seleccione una carrera</option>
                                    {% for carrera in carreras %}
                                    <option value="{{ carrera.id }}">{{ carrera.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Carrera que este docente tutoreará</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="curso" class="form-label">Curso</label>
                                <input type="text" class="form-control" id="curso" name="curso" placeholder="Ej: Primer Año, Segundo Año, etc.">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="formNuevoUsuario" class="btn btn-primary">Crear Usuario</button>
            </div>
        </div>
    </div>
</div>

<!-- Modales para asignar tutor a cada estudiante -->
{% for usuario in usuarios %}
{% if usuario.rol == 'usuario' %}
<div class="modal fade" id="asignarTutorModal{{ usuario.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Asignar Tutor a {{ usuario.nombre_completo or usuario.username }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.asignar_tutor', usuario_id=usuario.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="tutor_id{{ usuario.id }}" class="form-label">
                            <i class="fas fa-user-tie me-2"></i>Seleccionar Tutor/Docente
                        </label>
                        <select class="form-select" id="tutor_id{{ usuario.id }}" name="tutor_id">
                            <option value="">Sin tutor (Remover asignación)</option>
                            {% for docente in docentes %}
                            <option value="{{ docente.id }}" {% if usuario.tutor_id == docente.id %}selected{% endif %}>
                                {{ docente.nombre_completo or docente.username }}
                                {% if docente.curso %} - Curso: {{ docente.curso }}{% endif %}
                                {% if docente.email %} ({{ docente.email }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Seleccione el docente que será tutor de este estudiante. El tutor recibirá notificaciones e informes sobre este estudiante.
                        </div>
                    </div>
                    {% if usuario.tutor %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Tutor actual:</strong> {{ usuario.tutor.nombre_completo or usuario.tutor.username }}
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Guardar Asignación
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Modales para editar usuario -->
{% for usuario in usuarios %}
<div class="modal fade" id="editarUsuarioModal{{ usuario.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar {{ usuario.rol.title() }}: {{ usuario.nombre_completo or usuario.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.editar_usuario', usuario_id=usuario.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="nombre_completo{{ usuario.id }}" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="nombre_completo{{ usuario.id }}" name="nombre_completo" value="{{ usuario.nombre_completo or '' }}" pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+" title="Solo se permiten letras y espacios">
                            <small class="form-text text-muted">Solo se permiten letras y espacios</small>
                            <div class="invalid-feedback">Por favor solo ingrese letras y espacios</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="username{{ usuario.id }}" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="username{{ usuario.id }}" value="{{ usuario.username }}" disabled>
                            <small class="form-text text-muted">El nombre de usuario no se puede cambiar</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="email{{ usuario.id }}" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email{{ usuario.id }}" name="email" value="{{ usuario.email or '' }}" required>
                            <div class="invalid-feedback">Por favor ingrese un correo electrónico válido</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="telefono{{ usuario.id }}" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="telefono{{ usuario.id }}" name="telefono" value="{{ usuario.telefono or '' }}" maxlength="10" pattern="[0-9]{10}" title="Debe contener exactamente 10 números">
                            <small class="form-text text-muted">10 dígitos numéricos</small>
                            <div class="invalid-feedback">Por favor solo ingrese números, 10 números</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cedula{{ usuario.id }}" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="cedula{{ usuario.id }}" name="cedula" value="{{ usuario.cedula or '' }}" maxlength="10" pattern="[0-9]{10}" title="Debe contener exactamente 10 números">
                            <small class="form-text text-muted">10 dígitos numéricos</small>
                            <div class="invalid-feedback">Por favor solo ingrese números, 10 números</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="rol{{ usuario.id }}" class="form-label">Rol</label>
                            <select class="form-select" id="rol{{ usuario.id }}" name="rol" required>
                                <option value="usuario" {% if usuario.rol == 'usuario' %}selected{% endif %}>Usuario</option>
                                <option value="docente" {% if usuario.rol == 'docente' %}selected{% endif %}>Docente</option>
                                <option value="admin" {% if usuario.rol == 'admin' %}selected{% endif %}>Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="direccion{{ usuario.id }}" class="form-label">Dirección</label>
                        <textarea class="form-control" id="direccion{{ usuario.id }}" name="direccion" rows="2">{{ usuario.direccion or '' }}</textarea>
                    </div>
                    <!-- Campos para Usuario -->
                    {% if usuario.rol == 'usuario' %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="carrera_id{{ usuario.id }}" class="form-label">Carrera</label>
                            <select class="form-select" id="carrera_id{{ usuario.id }}" name="carrera_id">
                                <option value="">Seleccione una carrera</option>
                                {% for carrera in carreras %}
                                <option value="{{ carrera.id }}" {% if usuario.carrera_id == carrera.id %}selected{% endif %}>{{ carrera.nombre }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Se asignará automáticamente un tutor de esta carrera</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="semestre{{ usuario.id }}" class="form-label">Semestre</label>
                            <select class="form-select" id="semestre{{ usuario.id }}" name="semestre">
                                <option value="">Seleccione un semestre</option>
                                <option value="1" {% if usuario.semestre == 1 %}selected{% endif %}>Primer Semestre</option>
                                <option value="2" {% if usuario.semestre == 2 %}selected{% endif %}>Segundo Semestre</option>
                                <option value="3" {% if usuario.semestre == 3 %}selected{% endif %}>Tercer Semestre</option>
                                <option value="4" {% if usuario.semestre == 4 %}selected{% endif %}>Cuarto Semestre</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Campos para Docente -->
                    {% if usuario.rol == 'docente' %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="carrera_asignada_id{{ usuario.id }}" class="form-label">Carrera Asignada</label>
                            <select class="form-select" id="carrera_asignada_id{{ usuario.id }}" name="carrera_asignada_id">
                                <option value="">Seleccione una carrera</option>
                                {% for carrera in carreras %}
                                <option value="{{ carrera.id }}" {% if usuario.carrera_asignada_id == carrera.id %}selected{% endif %}>{{ carrera.nombre }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Carrera que este docente tutoreará</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="curso{{ usuario.id }}" class="form-label">Curso</label>
                            <input type="text" class="form-control" id="curso{{ usuario.id }}" name="curso" value="{{ usuario.curso or '' }}" placeholder="Ej: Primer Año, Segundo Año, etc.">
                        </div>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="activo{{ usuario.id }}" name="activo" {% if usuario.activo %}checked{% endif %}>
                            <label class="form-check-label" for="activo{{ usuario.id }}">
                                Usuario Activo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para resetear contraseña -->
<div class="modal fade" id="resetPasswordModal{{ usuario.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Resetear Contraseña: {{ usuario.nombre_completo or usuario.username }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.reset_password', usuario_id=usuario.id) }}" id="resetPasswordForm{{ usuario.id }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Usuario:</strong> {{ usuario.username }}</label><br>
                        <label class="form-label"><strong>Nombre:</strong> {{ usuario.nombre_completo or 'No especificado' }}</label><br>
                        <label class="form-label"><strong>Rol:</strong> 
                            <span class="badge bg-{{ 'danger' if usuario.rol == 'admin' else 'primary' if usuario.rol == 'docente' else 'info' }}">
                                {{ usuario.rol.title() }}
                            </span>
                        </label><br>
                        <label class="form-label"><strong>Email:</strong> {{ usuario.email or 'No tiene email registrado' }}</label>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> Se establecerá una nueva contraseña para este usuario. 
                        {% if usuario.email %}
                        La nueva contraseña será enviada al correo: <strong>{{ usuario.email }}</strong>
                        {% else %}
                        <strong>No tiene email registrado, la contraseña se mostrará aquí.</strong>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="nueva_password{{ usuario.id }}" class="form-label">Nueva Contraseña <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="nueva_password{{ usuario.id }}" name="nueva_password" required minlength="6" placeholder="Mínimo 6 caracteres">
                            <button type="button" class="btn btn-outline-secondary" onclick="generarPassword({{ usuario.id }})" title="Generar contraseña aleatoria">
                                <i class="fas fa-random"></i>
                            </button>
                        </div>
                        <div class="form-text">La contraseña debe tener al menos 6 caracteres</div>
                        <div class="invalid-feedback">La contraseña debe tener al menos 6 caracteres</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        El usuario deberá cambiar esta contraseña en su próximo inicio de sesión.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-key me-2"></i>Resetear Contraseña
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Toast Container para Notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="toastNotificacion" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
            <i class="fas fa-check-circle me-2"></i>
            <strong class="me-auto">Notificación</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Ha sido asignado un tutor.
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listeners a todos los enlaces de asignar tutor
    const tutorLinks = document.querySelectorAll('.asignar-tutor-link');
    tutorLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const usuarioId = this.getAttribute('data-usuario-id');
            const tutorId = this.getAttribute('data-tutor-id');
            const nombreUsuario = this.getAttribute('data-usuario-nombre');
            const nombreTutor = this.getAttribute('data-tutor-nombre');
            
            asignarTutor(usuarioId, tutorId, nombreUsuario, nombreTutor);
        });
    });
    
    // Validaciones para los modales de edición
    {% for usuario in usuarios %}
    // Validar nombre completo
    const nombreInput{{ usuario.id }} = document.getElementById('nombre_completo{{ usuario.id }}');
    if (nombreInput{{ usuario.id }}) {
        nombreInput{{ usuario.id }}.addEventListener('input', function() {
            this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]/g, '');
        });
        nombreInput{{ usuario.id }}.addEventListener('blur', function() {
            if (this.value && !/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(this.value)) {
                this.setCustomValidity('Por favor solo ingrese letras y espacios');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
    }
    
    // Validar teléfono
    const telefonoInput{{ usuario.id }} = document.getElementById('telefono{{ usuario.id }}');
    if (telefonoInput{{ usuario.id }}) {
        telefonoInput{{ usuario.id }}.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });
        telefonoInput{{ usuario.id }}.addEventListener('blur', function() {
            if (this.value && this.value.length !== 10) {
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
        telefonoInput{{ usuario.id }}.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            }
        });
    }
    
    // Validar cédula
    const cedulaInput{{ usuario.id }} = document.getElementById('cedula{{ usuario.id }}');
    if (cedulaInput{{ usuario.id }}) {
        cedulaInput{{ usuario.id }}.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });
        cedulaInput{{ usuario.id }}.addEventListener('blur', function() {
            if (this.value && this.value.length !== 10) {
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
        cedulaInput{{ usuario.id }}.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            }
        });
    }
    
    // Validar email
    const emailInput{{ usuario.id }} = document.getElementById('email{{ usuario.id }}');
    if (emailInput{{ usuario.id }}) {
        emailInput{{ usuario.id }}.addEventListener('blur', function() {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (this.value && !emailRegex.test(this.value)) {
                this.setCustomValidity('Por favor ingrese un correo electrónico válido');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
    }
    {% endfor %}
    
    // Validaciones para el modal de nuevo usuario
    const nombreNuevo = document.getElementById('nombre_completo');
    if (nombreNuevo) {
        nombreNuevo.addEventListener('input', function() {
            this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]/g, '');
        });
        nombreNuevo.addEventListener('blur', function() {
            if (this.value && !/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(this.value)) {
                this.setCustomValidity('Por favor solo ingrese letras y espacios');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
    }
    
    const telefonoNuevo = document.getElementById('telefono');
    if (telefonoNuevo) {
        telefonoNuevo.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });
        telefonoNuevo.addEventListener('blur', function() {
            if (this.value && this.value.length !== 10) {
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
        telefonoNuevo.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            }
        });
    }
    
    const cedulaNuevo = document.getElementById('cedula');
    if (cedulaNuevo) {
        cedulaNuevo.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
        });
        cedulaNuevo.addEventListener('blur', function() {
            if (this.value && this.value.length !== 10) {
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
        cedulaNuevo.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/[0-9]/.test(char)) {
                e.preventDefault();
                this.setCustomValidity('Por favor solo ingrese números, 10 números');
                this.classList.add('is-invalid');
            }
        });
    }
    
    const emailNuevo = document.getElementById('email');
    if (emailNuevo) {
        emailNuevo.addEventListener('blur', function() {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (this.value && !emailRegex.test(this.value)) {
                this.setCustomValidity('Por favor ingrese un correo electrónico válido');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
    }
});

// Función para generar contraseña aleatoria
function generarPassword(usuarioId) {
    const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let password = '';
    for (let i = 0; i < 10; i++) {
        password += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
    }
    const passwordInput = document.getElementById('nueva_password' + usuarioId);
    if (passwordInput) {
        passwordInput.value = password;
        passwordInput.classList.remove('is-invalid');
    }
}

// Validación de contraseña en los modales de reset
document.addEventListener('DOMContentLoaded', function() {
    {% for usuario in usuarios %}
    (function() {
        const resetForm = document.getElementById('resetPasswordForm{{ usuario.id }}');
        if (resetForm) {
            resetForm.addEventListener('submit', function(e) {
                const passwordInput = document.getElementById('nueva_password{{ usuario.id }}');
                if (passwordInput && passwordInput.value.length < 6) {
                    e.preventDefault();
                    passwordInput.classList.add('is-invalid');
                    return false;
                }
                if (passwordInput) {
                    passwordInput.classList.remove('is-invalid');
                }
            });
            
            const passwordInput = document.getElementById('nueva_password{{ usuario.id }}');
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    if (this.value.length >= 6) {
                        this.classList.remove('is-invalid');
                    }
                });
            }
        }
    })();
    {% endfor %}
});

function asignarTutor(usuarioId, tutorId, nombreUsuario, nombreTutor) {
    const formData = new FormData();
    if (tutorId && tutorId !== '') {
        formData.append('tutor_id', tutorId);
    } else {
        formData.append('tutor_id', '');
    }
    
    fetch('/admin/usuarios/' + usuarioId + '/asignar-tutor', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(function(response) {
        if (response.ok) {
            // Mostrar notificación toast
            const toastMessage = document.getElementById('toastMessage');
            if (tutorId && tutorId !== '') {
                toastMessage.textContent = 'Ha sido asignado un tutor a ' + nombreUsuario + '. Tutor: ' + nombreTutor;
            } else {
                toastMessage.textContent = 'Tutor removido de ' + nombreUsuario;
            }
            
            const toastElement = document.getElementById('toastNotificacion');
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Recargar la página después de un breve delay para ver la notificación
            setTimeout(function() {
                window.location.reload();
            }, 1500);
        } else {
            alert('Error al asignar tutor');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        alert('Error al asignar tutor');
    });
}

// Función para mostrar/ocultar campos según el rol seleccionado
function toggleCamposPorRol() {
    const rol = document.getElementById('rol');
    if (!rol) return;
    
    const rolValue = rol.value;
    const camposUsuario = document.getElementById('camposUsuario');
    const camposDocente = document.getElementById('camposDocente');
    
    if (camposUsuario && camposDocente) {
        if (rolValue === 'usuario') {
            camposUsuario.style.display = 'block';
            camposDocente.style.display = 'none';
        } else if (rolValue === 'docente') {
            camposUsuario.style.display = 'none';
            camposDocente.style.display = 'block';
        } else {
            camposUsuario.style.display = 'none';
            camposDocente.style.display = 'none';
        }
    }
}

// Función para toggle de mostrar/ocultar contraseña en el formulario de nuevo usuario
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar campos según el rol por defecto
    const rolSelect = document.getElementById('rol');
    if (rolSelect) {
        rolSelect.addEventListener('change', toggleCamposPorRol);
        toggleCamposPorRol(); // Inicializar al cargar
    }
    const togglePasswordNuevoUsuario = document.getElementById('togglePasswordNuevoUsuario');
    const passwordNuevoUsuario = document.getElementById('password');
    const eyeIconNuevoUsuario = document.getElementById('eyeIconNuevoUsuario');
    
    if (togglePasswordNuevoUsuario && passwordNuevoUsuario && eyeIconNuevoUsuario) {
        togglePasswordNuevoUsuario.addEventListener('click', function() {
            const type = passwordNuevoUsuario.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordNuevoUsuario.setAttribute('type', type);
            
            // Cambiar icono
            if (type === 'password') {
                eyeIconNuevoUsuario.classList.remove('fa-eye-slash');
                eyeIconNuevoUsuario.classList.add('fa-eye');
            } else {
                eyeIconNuevoUsuario.classList.remove('fa-eye');
                eyeIconNuevoUsuario.classList.add('fa-eye-slash');
            }
        });
    }
});
</script>
{% endblock %}

