{% extends "admin_base.html" %}

{% block title %}Gestión de Citas - Panel Admin{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-check me-2"></i>Gestión de Citas</h2>
    <div class="btn-group">
        <a href="/admin/citas/nueva" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Nueva Cita
        </a>
        <button class="btn btn-outline-primary">
            <i class="fas fa-filter me-2"></i>Filtrar
        </button>
        <button class="btn btn-outline-secondary">
            <i class="fas fa-download me-2"></i>Exportar
        </button>
    </div>
</div>
    
{% if citas %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Usuario</th>
                                        <th>Carrera</th>
                                        <th>Semestre</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Motivo</th>
                                        <th>Archivos</th>
                                        <th>Estado</th>
                                        <th>Atenderá</th>
                                        <th>Fecha Creación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cita in citas %}
                                    <tr>
                                        <td>{{ cita.id }}</td>
                                        <td>
                                            <div>
                                                <strong>{{ cita.usuario.nombre_completo }}</strong><br>
                                                <small class="text-muted">{{ cita.usuario.cedula }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if cita.carrera %}
                                                {{ cita.carrera.nombre }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cita.semestre %}
                                                {{ cita.semestre }}° Semestre
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ cita.fecha.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ cita.hora.strftime('%H:%M') }}</td>
                                        <td>{{ cita.motivo }}</td>
                                        <td>
                                            {% set archivos = cita.get_archivos_adjuntos() %}
                                            {% if archivos %}
                                                <div class="btn-group">
                                                    {% for archivo in archivos %}
                                                    <a href="{{ url_for('descargar_archivo_cita', cita_id=cita.id, filename=archivo) }}" 
                                                       class="btn btn-sm btn-outline-primary" 
                                                       title="{{ archivo }}">
                                                        <i class="fas {{ 'fa-file-pdf text-danger' if archivo.endswith('.pdf') else 'fa-file-image text-info' }}"></i>
                                                    </a>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set estado_cita = (cita.estado or '')|string|lower|trim %}
                                            <span class="badge bg-{{ 'warning' if estado_cita == 'pendiente' or estado_cita == 'pospuesta' else 'success' if estado_cita == 'confirmada' else 'danger' }}">
                                                {{ cita.estado.title() }}
                                            </span>
                                            {% if cita.esta_pospuesta() %}
                                                <br><small class="text-muted">
                                                    Nueva: {{ cita.fecha_pospuesta.strftime('%d/%m/%Y') }} {{ cita.hora_pospuesta.strftime('%H:%M') }}
                                                </small>
                                            {% endif %}
                                            {% if estado_cita == 'pendiente' %}
                                            <!-- BOTONES: ACEPTAR Y RECHAZAR - SOLO PARA CITAS PENDIENTES -->
                                            <div class="mt-2 d-flex flex-column gap-2">
                                                <form method="POST" action="/admin/cita/{{ cita.id }}/aprobar" class="d-inline" onsubmit="return confirm('¿Aceptar esta cita? Se enviará una notificación por correo al solicitante indicando que su cita ha sido aceptada.');">
                                                    <button type="submit" class="btn btn-success btn-sm w-100">
                                                        <i class="fas fa-check me-1"></i>Aceptar
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#rechazarModal{{ cita.id }}">
                                                    <i class="fas fa-times me-1"></i>Rechazar
                                                </button>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cita.gestora %}
                                            <div class="text-center">
                                                <strong class="text-primary">{{ cita.gestora.nombre_completo }}</strong><br>
                                                <small class="text-muted">{{ cita.gestora.curso or 'GESTORA DE BIENESTAR INSTITUCIONAL' }}</small>
                                            </div>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if cita.esta_pospuesta() %}
                                                <div class="alert alert-warning mb-0 p-2">
                                                    <strong><i class="fas fa-calendar-alt me-1"></i>Pospuesta:</strong><br>
                                                    <small>Nueva fecha: {{ cita.fecha_pospuesta.strftime('%d/%m/%Y') }} a las {{ cita.hora_pospuesta.strftime('%H:%M') }}</small><br>
                                                    <small><strong>Motivo:</strong> {{ cita.motivo_posposicion }}</small>
                                                    {% if cita.get_archivos_posposicion() %}
                                                        <br><small>
                                                            <strong>Archivos:</strong>
                                                            {% for archivo in cita.get_archivos_posposicion() %}
                                                                <a href="{{ url_for('descargar_archivo_posposicion', cita_id=cita.id, filename=archivo) }}" class="text-primary">
                                                                    <i class="fas fa-file me-1"></i>{{ archivo.split('_', 1)[1] if '_' in archivo else archivo }}
                                                                </a>
                                                            {% endfor %}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                {{ cita.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set estado_actual = (cita.estado or '')|string|lower|trim %}
                                            {% if estado_actual == 'pendiente' %}
                                            <!-- BOTONES: ACEPTAR Y RECHAZAR - SOLO PARA CITAS PENDIENTES -->
                                            <div class="d-flex flex-column gap-2">
                                                <form method="POST" action="/admin/cita/{{ cita.id }}/aprobar" class="d-inline" onsubmit="return confirm('¿Aceptar esta cita? Se enviará una notificación por correo al solicitante indicando que su cita ha sido aceptada.');">
                                                    <button type="submit" class="btn btn-success w-100">
                                                        <i class="fas fa-check-circle me-2"></i><strong>Aceptar</strong>
                                                    </button>
                                                </form>
                                                <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#rechazarModal{{ cita.id }}">
                                                    <i class="fas fa-times-circle me-2"></i><strong>Rechazar</strong>
                                                </button>
                                            </div>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Estadísticas -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ citas|selectattr('estado', 'equalto', 'pendiente')|list|length + citas|selectattr('estado', 'equalto', 'Pendiente')|list|length }}</h4>
                                <p class="mb-0">Pendientes</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ citas|selectattr('estado', 'equalto', 'confirmada')|list|length }}</h4>
                                <p class="mb-0">Confirmadas</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ citas|selectattr('estado', 'equalto', 'cancelada')|list|length }}</h4>
                                <p class="mb-0">Canceladas</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-times fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="mb-0">{{ citas|length }}</h4>
                                <p class="mb-0">Total</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card text-center">
                    <div class="card-body py-5">
                        <i class="fas fa-calendar-times text-muted mb-3" style="font-size: 4rem;"></i>
                        <h4 class="text-muted">No hay citas programadas</h4>
                        <p class="text-muted">Las citas aparecerán aquí una vez que los usuarios las agenden</p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modales para rechazar citas -->
{% for cita in citas %}
{% set estado_cita = (cita.estado or '')|string|lower|trim %}
{% if estado_cita == 'pendiente' or 'pendiente' in estado_cita %}
<div class="modal fade" id="rechazarModal{{ cita.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rechazar Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/cita/{{ cita.id }}/rechazar" onsubmit="return confirm('¿Confirmar rechazo de esta cita? Se enviará una notificación por correo al solicitante.');">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-envelope me-2"></i>
                        <strong>Notificación por correo:</strong> Se enviará una notificación al correo del solicitante: 
                        <strong>{{ cita.usuario.email if cita.usuario.email else 'No tiene email registrado' }}</strong>
                    </div>
                    <p><strong>¿Está seguro de rechazar esta cita?</strong></p>
                    <div class="mb-3">
                        <strong>Usuario:</strong> {{ cita.usuario.nombre_completo }}<br>
                        <strong>Fecha:</strong> {{ cita.fecha.strftime('%d/%m/%Y') }}<br>
                        <strong>Hora:</strong> {{ cita.hora.strftime('%H:%M') }}<br>
                        <strong>Motivo:</strong> {{ cita.motivo }}
                    </div>
                    <div class="mb-3">
                        <label for="observaciones{{ cita.id }}" class="form-label">Observaciones (opcional):</label>
                        <textarea class="form-control" id="observaciones{{ cita.id }}" name="observaciones" rows="3" placeholder="Motivo del rechazo... (Estas observaciones se incluirán en el correo al solicitante)"></textarea>
                        <small class="form-text text-muted">Las observaciones se enviarán al correo del solicitante.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-1"></i>Rechazar Cita y Enviar Notificación
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endif %}
{% endfor %}
{% endblock %}

